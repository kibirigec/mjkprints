/**
 * PayPal Webhook Test Script
 * Simulates PayPal webhook events for testing
 */

import { config } from 'dotenv'
import fetch from 'node-fetch'

// Load environment variables
config()

async function testPayPalWebhook() {

  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'
  const webhookUrl = `${baseUrl}/api/webhooks/paypal`


  // Test webhook payload - simulating a payment capture completed event
  const testPayload = {
    id: 'WH-test-event-id',
    event_version: '1.0',
    create_time: new Date().toISOString(),
    resource_type: 'capture',
    event_type: 'PAYMENT.CAPTURE.COMPLETED',
    summary: 'Payment completed for test order',
    resource: {
      id: 'test-capture-id',
      status: 'COMPLETED',
      amount: {
        currency_code: 'USD',
        value: '24.98'
      },
      final_capture: true,
      seller_protection: {
        status: 'ELIGIBLE'
      },
      custom_id: 'test-order-' + Date.now(),
      create_time: new Date().toISOString(),
      update_time: new Date().toISOString(),
      supplementary_data: {
        related_ids: {
          order_id: 'test-paypal-order-id'
        }
      },
      payer: {
        email_address: 'test@mjkprints.com',
        payer_id: 'test-payer-id'
      }
    },
    links: [
      {
        href: `https://api.sandbox.paypal.com/v1/notifications/webhooks-events/WH-test-event-id`,
        rel: 'self',
        method: 'GET'
      }
    ]
  }

  // Mock PayPal webhook headers (normally these would be generated by PayPal)
  const mockHeaders = {
    'paypal-auth-algo': 'SHA256withRSA',
    'paypal-cert-id': 'test-cert-id',
    'paypal-transmission-id': 'test-transmission-id',
    'paypal-transmission-sig': 'test-signature',
    'paypal-transmission-time': new Date().toISOString()
  }

  
  try {
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...mockHeaders
      },
      body: JSON.stringify(testPayload)
    })

    
    if (response.ok) {
      const responseData = await response.json()
    } else {
      const errorText = await response.text()
      
      if (response.status === 400 && errorText.includes('signature')) {
      }
    }

  } catch (error) {
    console.error(`   Error: ${error.message}`)
    
    if (error.code === 'ECONNREFUSED') {
    }
  }



}

// Run the test
testPayPalWebhook().catch(console.error)